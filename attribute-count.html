<html>
<head> 
	<title> Beastiary attribute counting test </title>

	<!-- Stylesheets --> 
	<link rel="stylesheet" type="text/css" href="lib/textillate/assets/animate.css">
	<!--<link rel="stylesheet" type="text/css" href="lib/textillate/assets/animate.css">-->
	<style>
		.results
		{
			margin:auto;
			max-width:60%;
		}
	</style>
</head> 

<body> 

	<h1> Attribute Counting Test </h1>
	<button onclick="downloadFile()">Download JSON</button>
	<div class="results">
	</div>
</body> 

<!-- Scripts --> 
	<!-- Beastiary JSON --> 
	<script src="reference/clean-beastiary-2.js"> </script>
	<!-- jQuery --> 
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

	<!-- Includes for Textillate --> 
	<script src="lib/textillate/assets/jquery.lettering.js"></script>
	<script src="lib/textillate/assets/jquery.fittext.js"></script>
	<script src="lib/textillate/jquery.textillate.js"></script>

	<!-- Test Script, move once done --> 
	<script>

		var beasts = beastiary;
		var consoleCount = 0;
		// Array of objects representing distinct value/count per attribute
		var distinctValues = []; 
		var total = [];

		window.onload = function()
		{
			appendText('Window Loaded');
			appendText(beasts.length + ' monsters loaded.');

			// Get keys. 
			appendText('Monster attributes found:');
			var monsterKeys = getMonsterKeys(beasts[0]);

			//appendText('Checking distinct values for ' + monsterKeys[1]);
			//checkAttributeDistinctNameCount(monsterKeys[1]);

			/*for(var i = 1; i < monsterKeys.length; i++)
			{
				appendText('Checking distinct values for ' + monsterKeys[i]);
				checkAttributeDistinctNameCount(monsterKeys[i]);
				appendText('---------------------------------------------------------', 'green');
			}*/
			//total = printJSON(beasts); 
			//console.log(total);
			//appendText(JSON.stringify(total);
			//appendText('Preparing download...', 'red');
			//saveText( JSON.stringify(total), "filename.json" );
			//download_csv(JSON.stringify(total);
		}; 

		/*filename, content*/
		/*var downloadFile = function() 
		{
			console.log('download file');

			var filename = 'beasts.js';
			var content = JSON.stringify(total);
			var blob = new Blob([content]);
			var evt = document.createEvent("HTMLEvents");
			evt.initEvent("click");
			$("<a>", {
			  download: filename,
			  href: webkitURL.createObjectURL(blob)
			}).get(0).dispatchEvent(evt);
		};

		function saveText(text, filename)
		{
		  var a = document.createElement('a');
		  a.setAttribute('href', 'data:text/plain;charset=utf-u,'+encodeURIComponent(text));
		  a.setAttribute('download', filename);
		  a.click()
		};


		function download_csv() 
		{
			var obj = JSON.stringify(total);
		    var hiddenElement = document.createElement('a');
		    hiddenElement.href = 'data:text/json;charset=utf-8,' + encodeURI(obj);
		    hiddenElement.target = '_blank';
		    hiddenElement.download = 'beastiary.csv';
		    hiddenElement.click();
		}*/
		printJSON = function(obj)
		{
			var totality = [];
			for(var i = 0; i< obj.length; i++)
			{
				totality.push(
				{
					name: obj[i].name,
					alignment: nonVals(obj[i].alignment),
					xpDropped: parseInt(obj[i].drops.xp),
				    treasureDropped : nonVals(obj[i].drops.treasure), 
				    gearDropped : nonVals(obj[i].drops.gear), 
				    type: nonVals(obj[i].classifications.type),
				    subtypes : obj[i].classifications.subtype,
				    group: nonVals(obj[i].classifications.group),
				    sq: nonVals(obj[i].features.sq),
				    environment: nonVals(obj[i].features.environment),
				    organization: nonVals(obj[i].features.organization),
				    isCharacter: nonVals(obj[i].isCharacter), 
				    isCompanion: nonVals(obj[i].isCompanion), 
				    savingThrowFort: nonVals(obj[i].savingThrows.fort),
				    savingThrowRef: nonVals(obj[i].savingThrows.ref), 
				    savingThrowWil: nonVals(obj[i].savingThrows.wil),
				    cr: nonVals(obj[i].combatInfo.cr), 
				    melee: nonVals(obj[i].combatInfo.melee), 
				    ranged: nonVals(obj[i].combatInfo.ranged), 
				    ac: nonVals(obj[i].combatInfo.ac), 
				    acTouch: nonVals(obj[i].combatInfo.ac_touch), 
				    acFlatfooted: nonVals(obj[i].combatInfo.ac_flatFooted), 
				    size: nonVals(obj[i].spatial.size),
				    space: nonVals(obj[i].spatial.space), 
				    reach: nonVals(obj[i].spatial.reach), 
				    abilityStrength: nonVals(obj[i].abilityScores.str), 
				    abilityDex: nonVals(obj[i].abilityScores.dex), 
				    abilityCon: nonVals(obj[i].abilityScores.con), 
				    abilityInt: nonVals(obj[i].abilityScores.int), 
				    abilityWis: nonVals(obj[i].abilityScores.wis), 
				    abilityCha: nonVals(obj[i].abilityScores.cha),
				    hitDie: nonVals(obj[i].hitPoints.hitDie), 
				    averageHP: nonVals(obj[i].hitPoints.hp), 
				    feats: [],
				    skills: [],
				    baseSpeed: nonVals(obj[i].speed.baseSpeed),
				    flySpeed: nonVals(obj[i].speed.flySpeed), 
				    maneuverability: nonVals(obj[i].speed.maneuverability),
				    climbSpeed: nonVals(obj[i].speed.climbSpeed), 
				    swimSpeed: nonVals(obj[i].speed.swimSpeed), 
				    burrowSpeed: nonVals(obj[i].speed.burrowSpeed), 
				    speedSpecial: nonVals(obj[i].speed.speedSpecial), 
				    speedLand: nonVals(obj[i].speed.speedLand), 
				    fly: nonVals(obj[i].speed.fly),
				    climb: nonVals(obj[i].speed.climb),
				    burrow: nonVals(obj[i].speed.burrow), 
				    swim: nonVals(obj[i].speed.swim), 
				    notes: nonVals(obj[i].notes)
				});
			}
			return totality;
		};

		nonVals = function(val)
		{
			if(val === 'none' || val === '' || val === undefined  || val === '-')
			{
				return null;
			}
			else
			{
				return val;
			}
		};

		// Get each distinct name and count of those names 
		// across a given attribute. 
		// Order by count descending. 
		checkAttributeDistinctNameCount = function(attributeName)
		{
			newAttribute = {};
			
			// Get counts
			for(var i = 0; i< beasts.length; i++)
			{
				//console.log(beasts[i][attributeName]);
				// If this name already exists, increment count
				var value = beasts[i][attributeName];
				if(newAttribute[value] !== undefined)
				{
					(newAttribute[value]).count ++;
				}
				else
				{
					newAttribute[beasts[i][attributeName]] = {}; 
					(newAttribute[beasts[i][attributeName]]).count = 1;
				}
			}

			for(var k in newAttribute)
			{
				appendText(k + ': ' + newAttribute[k].count);
			} 
			//appendText(newAttribute, 'red');

			// Sort descending
		};


		// Add text to the "results" div. 
		// Practicing using textillate.js as well here.
		appendText = function(logText, color)
		{
			var newSelector = 'log' + consoleCount; 

			$('<p/>',
			{
				class: newSelector, 
				text: logText
			}).appendTo('.results');

			$('.' + newSelector).textillate(
				{ 
					in: { effect: 'pulse' }
				});

			if(color)
			{
				$('.' + newSelector).css('color', color);
			}
			else
			{
				$('.' + newSelector).css('color', 'black');
			}
			
			consoleCount ++;
		};

		// Given one object, get the keys of that object.
		getMonsterKeys = function(obj)
		{
			var keys = [];

			for(var k in obj)
			{
				appendText(k, 'blue');
				keys.push(k);
			} 
			return keys;
		};
	</script>
<!-- End Scripts --> 

</html>